<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Orders – Madhavi Enterprises</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f3f6fa; margin:0; padding:0;}
    .container { max-width: 900px; margin: 2rem auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.07); padding: 1.5rem;}
    h1 { color: #0066c0; margin-bottom: 1rem;}
    .order-row { background: #fff; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border:1px solid #e6eefc; display:grid; grid-template-columns: 1fr 300px; gap:12px; align-items:start;}
    .order-info { font-size: 0.96rem; color:#123;}
    .order-meta { font-size: 0.9rem; color:#444; display:flex; flex-direction:column; gap:8px;}
    .order-meta select, .order-meta button, .order-meta input[type="checkbox"] { padding:6px 8px; font-size:0.95rem; }
    .badge { display:inline-block; padding:4px 8px; border-radius:12px; font-weight:600; font-size:0.85rem; }
    .badge.pending { background:#fff4e5; color:#9a6400; border:1px solid #ffd8a8; }
    .badge.success { background:#e9f9ee; color:#0b6a2f; border:1px solid #bbf0c4; }
    .small { font-size:0.85rem; color:#666; margin-top:6px;}
    .controls { display:flex; gap:8px; align-items:center; }
    .btn { background:#0066c0; color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; }
    .btn.ghost { background:#f0f4fb; color:#003366; border:1px solid #dbe8ff; }
    .muted { color:#777; font-size:0.9rem; }
    .no-orders { padding:1rem; background:#fff; border-radius:8px; border:1px dashed #d7e8ff; color:#375; }
    @media (max-width:760px){
      .order-row { grid-template-columns: 1fr; }
      .order-meta { width:100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin: Orders Received</h1>
    <div id="orders-list"></div>
    <div style="margin-top:1rem;">
      <a href="index.html" class="btn ghost">Back to Home</a>
      <button id="clearAll" class="btn" style="float:right;background:#c0392b">Clear All Orders</button>
    </div>
  </div>

<script type="module">
  import { auth, db } from './firebase.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { collectionGroup, onSnapshot, query, orderBy, updateDoc, deleteDoc, doc } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const STATUS_FLOW = ['Pending','Payment Verified','Dispatched','In Transit','Out for Delivery','Delivered'];

  let ordersCache = []; // keep track of docs with their Firestore paths

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      loadOrders();
    }
  });

  function loadOrders() {
    const ordersDiv = document.getElementById('orders-list');
    const q = query(collectionGroup(db, "userOrders"), orderBy("createdAt", "desc"));

    onSnapshot(q, (snap) => {
      ordersCache = [];
      if (snap.empty) {
        ordersDiv.innerHTML = '<div class="no-orders">No orders yet.</div>';
        return;
      }
      ordersDiv.innerHTML = "";
      snap.forEach(docSnap => {
        const data = docSnap.data() || {};
        const refPath = docSnap.ref.path;
        ordersCache.push({ refPath, data });

        const items = (data.cart || []).map(i => `${i.name} × ${i.qty}`).join(', ');
        const status = data.status || 'Pending';
        const paymentReceived = !!data.paymentReceived;
        const badgeClass = (status === 'Pending') ? 'badge pending' : 'badge success';
        const paymentText = paymentReceived ? 'Received' : 'Pending';
        const orderTime = data.orderTime || (data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : '');
        const options = STATUS_FLOW.map(s => `<option value="${s}" ${s===status ? 'selected':''}>${s}</option>`).join('');

        const div = document.createElement("div");
        div.className = "order-row";
        div.innerHTML = `
          <div class="order-info">
            <div><b>Name:</b> ${escapeHtml(data.name || '')}</div>
            <div class="small"><b>Address:</b> ${escapeHtml(data.address || '')}</div>
            <div class="small"><b>Items:</b> ${escapeHtml(items)}</div>
            <div class="small"><b>Total:</b> ₹${data.total || 0} &nbsp; <span class="${badgeClass}">${escapeHtml(status)}</span></div>
            <div class="small"><b>Payment:</b> <span class="${paymentReceived ? 'badge success' : 'badge pending'}">${paymentText}</span></div>
            <div class="small"><b>Order Time:</b> ${escapeHtml(orderTime)}</div>
            ${data.upiTxnId ? `<div class="small"><b>UPI Txn ID:</b> ${escapeHtml(data.upiTxnId)}</div>` : ''}
          </div>

          <div class="order-meta">
            <label>Change status</label>
            <select class="status-select">${options}</select>

            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" class="payment-check" ${paymentReceived ? 'checked' : ''} />
              Mark payment received
            </label>

            <div class="controls">
              <button class="btn save">Save</button>
              <button class="btn ghost delete">Delete</button>
            </div>
          </div>
        `;

        // Attach event listeners
        div.querySelector('.save').addEventListener('click', () => saveOrderChanges(refPath, div));
        div.querySelector('.delete').addEventListener('click', () => deleteOrder(refPath));

        ordersDiv.appendChild(div);
      });
    });
  }

  async function saveOrderChanges(refPath, rowEl) {
    const sel = rowEl.querySelector('.status-select').value;
    const paymentChecked = rowEl.querySelector('.payment-check').checked;
    const ref = doc(db, refPath);
    await updateDoc(ref, {
      status: sel,
      paymentReceived: paymentChecked,
      paymentVerifiedAt: paymentChecked ? new Date().toLocaleString() : null
    });
    alert('Order updated in Firestore.');
  }

  async function deleteOrder(refPath) {
    if (!confirm('Delete this order permanently?')) return;
    const ref = doc(db, refPath);
    await deleteDoc(ref);
    alert('Order deleted from Firestore.');
  }

  function escapeHtml(str){
    return String(str||'').replace(/&/g,'&amp;')
                          .replace(/</g,'&lt;')
                          .replace(/>/g,'&gt;')
                          .replace(/"/g,'&quot;');
  }
</script>
</body>
</html>
