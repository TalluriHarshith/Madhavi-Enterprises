<!doctype html>
<html>
<head><meta charset="utf-8"><title>Protected</title></head>
<body>
  <h1>Protected Page</h1>
  <div id="userInfo"></div>
  <form id="noteForm">
    <input name="text" placeholder="Write a note" required />
    <button type="submit">Save Note</button>
  </form>
  <ul id="notes"></ul>
  <button id="logout">Logout</button>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { collection, addDoc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    let currentUser = null;
    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = '/index.html';
      currentUser = user;
      document.getElementById('userInfo').textContent = 'Signed in: ' + user.email;
      // load user notes
      const q = query(collection(db, 'notes'), where('ownerId', '==', user.uid));
      const snap = await getDocs(q);
      const list = document.getElementById('notes');
      list.innerHTML = '';
      snap.forEach(d => {
        const li = document.createElement('li');
        li.textContent = d.data().text;
        list.appendChild(li);
      });
    });

    document.getElementById('noteForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      await addDoc(collection(db, 'notes'), { text: fd.get('text'), ownerId: currentUser.uid, createdAt: Date.now() });
      window.location.reload();
    });

    document.getElementById('logout').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = '/index.html';
    });
  </script>
</body>
</html>
